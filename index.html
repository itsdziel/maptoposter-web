<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>MapToPoster</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:24px;max-width:780px}
    .card{border:1px solid #ddd;border-radius:14px;padding:16px}
    label{display:block;margin-top:10px;font-weight:600}
    input,select{width:100%;padding:10px;border:1px solid #ccc;border-radius:12px}
    button{margin-top:14px;padding:10px 14px;border:0;border-radius:12px;cursor:pointer;background:#731d1f;color:#fff}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .msg{margin-top:12px;white-space:pre-wrap}
    img{max-width:100%;border-radius:14px;border:1px solid #eee;margin-top:16px}
    a{color:#731d1f}
  </style>
</head>
<body>
  <h1>MapToPoster</h1>
  <div class="card">
    <div class="row">
      <div>
        <label>City</label>
        <input id="city" value="Jakarta">
      </div>
      <div>
        <label>Country</label>
        <input id="country" value="Indonesia">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Theme</label>
        <select id="theme"></select>
      </div>
      <div>
        <label>Distance (meter)</label>
        <input id="distance" type="number" min="1000" max="100000" step="1000" value="8000">
      </div>
    </div>

    <button id="btn">Generate</button>
    <div id="msg" class="msg"></div>
    <img id="preview" style="display:none"/>
    <p id="dlwrap" style="display:none"><a id="dl" download="map.png">Download PNG</a></p>
  </div>

<script>
  const API_BASE = "https://maptoposter-api.onrender.com";

  const msg = (t) => document.getElementById("msg").textContent = t || "";
  const preview = document.getElementById("preview");
  const dlwrap = document.getElementById("dlwrap");
  const dl = document.getElementById("dl");

  async function loadThemes(){
    msg("Loading themes...");
    const r = await fetch(`${API_BASE}/health`);
    if(!r.ok) throw new Error("Failed to load themes");
    const j = await r.json();
    const sel = document.getElementById("theme");
    sel.innerHTML = "";
    (j.themes || []).forEach(t=>{
      const o = document.createElement("option");
      o.value = t; o.textContent = t;
      sel.appendChild(o);
    });
    msg("");
  }

async function sleep(ms){ return new Promise(r => setTimeout(r, ms)); }

async function generate(){
  msg("Starting job...");
  preview.style.display = "none";
  dlwrap.style.display = "none";

  const payload = {
    city: document.getElementById("city").value,
    country: document.getElementById("country").value,
    theme: document.getElementById("theme").value,
    distance: Number(document.getElementById("distance").value)
  };

  // 1) Start async job
  const start = await fetch(`${API_BASE}/generate_async`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if(!start.ok){
    let err = "Failed to start job";
    try { err = (await start.json()).detail || err; } catch(e){}
    msg("Error: " + err);
    return;
  }

  const startJson = await start.json();
  const jobId = startJson.job_id;

  // 2) Poll job status
  for(let i=0; i<120; i++){ // up to ~120 * 2s = 240s
    msg(`Generating... (job ${jobId})`);
    const st = await fetch(`${API_BASE}/job/${jobId}`);
    if(!st.ok){
      msg("Error: failed to check job status");
      return;
    }
    const j = await st.json();

    if(j.status === "DONE"){
      // 3) Download image
      const imgRes = await fetch(`${API_BASE}/download/${jobId}`);
      if(!imgRes.ok){
        msg("Error: failed to download result");
        return;
      }
      const blob = await imgRes.blob();
      const url = URL.createObjectURL(blob);

      preview.src = url;
      preview.style.display = "block";

      dl.href = url;
      dl.download = `${payload.city}_${payload.theme}.png`;
      dlwrap.style.display = "block";

      msg("Done!");
      return;
    }

    if(j.status === "ERROR"){
      msg("Error: " + (j.message || "Generation failed"));
      return;
    }

    await sleep(2000);
  }

  msg("Error: still running, please try again.");
}


  document.getElementById("btn").addEventListener("click", generate);
  loadThemes().catch(e => msg("Error: " + e.message));
</script>
</body>
</html>
